<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://apis.google.com https://accounts.google.com https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://accounts.google.com https://www.googleapis.com https://drive.google.com https://oauth2.googleapis.com; frame-src https://accounts.google.com;">
    <title>é ˜åæ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - Google Driveé€£æº</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;600;700&family=Outfit:wght@600;800&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #2d5a8c;
            --secondary: #4a90e2;
            --accent: #ff6b6b;
            --success: #51cf66;
            --warning: #ffd93d;
            --google: #4285f4;
            --bg-card: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #6c757d;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.12);
        }
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 1.5rem 1rem;
            color: var(--text-primary);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        
        .header h1 {
            font-family: 'Outfit', sans-serif;
            font-weight: 800;
            font-size: 2.2rem;
            color: white;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            margin-bottom: 0.5rem;
        }
        
        .header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.95rem;
        }
        
        /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
        .login-card {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            max-width: 500px;
            margin: 3rem auto;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }
        
        .login-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
        }
        
        .login-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }
        
        .login-description {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            line-height: 1.6;
        }
        
        .google-signin-btn {
            display: inline-flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 2rem;
            background: var(--google);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
        }
        
        .google-signin-btn:hover {
            background: #3367d6;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
        }
        
        .google-signin-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ */
        .user-bar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 2px solid var(--google);
        }
        
        .user-details {
            display: flex;
            flex-direction: column;
        }
        
        .user-name {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .user-email {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .signout-btn {
            padding: 0.6rem 1.2rem;
            background: #ea4335;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .signout-btn:hover {
            background: #c5221f;
            transform: translateY(-1px);
        }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ */
        .main-card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
        }
        
        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .form-group label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.8rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        /* ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ */
        .image-upload-area {
            border: 3px dashed #d0d0d0;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        .image-upload-area:hover {
            border-color: var(--secondary);
            background: #e7f3ff;
        }
        
        .image-upload-area.dragover {
            border-color: var(--success);
            background: #e6f9ef;
        }
        
        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .upload-text {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        
        .upload-hint {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        #fileInput {
            display: none;
        }
        
        /* ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
        .image-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .image-preview-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .image-preview-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        
        .remove-image-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .remove-image-btn:hover {
            background: rgba(255, 0, 0, 1);
            transform: scale(1.1);
        }
        
        /* ãƒœã‚¿ãƒ³ */
        .btn-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.9rem 1.8rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #234569;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(45, 90, 140, 0.3);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #40c057;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(81, 207, 102, 0.3);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        /* é ˜åæ›¸ãƒªã‚¹ãƒˆ */
        .receipt-list {
            margin-top: 2rem;
        }
        
        .receipt-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .receipt-table th,
        .receipt-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .receipt-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .receipt-table tr:hover {
            background: #f8f9fa;
        }
        
        .receipt-image-thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .receipt-image-thumb:hover {
            transform: scale(1.1);
        }
        
        .delete-receipt-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .delete-receipt-btn:hover {
            background: #ff5252;
            transform: translateY(-1px);
        }
        
        /* çµ±è¨ˆæƒ…å ± */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
        }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .message {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }
        
        .message.show {
            display: block;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }
            .main-card {
                padding: 1.5rem;
            }
            .form-grid {
                grid-template-columns: 1fr;
            }
            .receipt-table {
                font-size: 0.85rem;
            }
            .receipt-table th,
            .receipt-table td {
                padding: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š é ˜åæ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>Google Driveé€£æº - æ¨ªæµœãƒ»é«˜çŸ¥ã©ã“ã‹ã‚‰ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½</p>
        </div>
        
        <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
        <div id="loginSection">
            <div class="login-card">
                <div class="login-icon">ğŸ”</div>
                <div class="login-title">Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³</div>
                <div class="login-description">
                    Google Driveã«æ¥ç¶šã—ã¦ã€é ˜åæ›¸ã‚’å®‰å…¨ã«ä¿å­˜ãƒ»ç®¡ç†ã—ã¾ã™ã€‚<br>
                    æ¨ªæµœã¨é«˜çŸ¥ã€ã©ã“ã‹ã‚‰ã§ã‚‚åŒã˜ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚
                </div>
                <button class="google-signin-btn" id="loginBtn" onclick="handleAuthClick()">
                    <span>ğŸ”µ</span>
                    <span>Googleã§ãƒ­ã‚°ã‚¤ãƒ³</span>
                </button>
                <div class="loading" id="loginLoading">
                    <div class="spinner"></div>
                    <p>Googleèªè¨¼ã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™...</p>
                </div>
            </div>
        </div>
        
        <!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª -->
        <div id="appSection" style="display: none;">
            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãƒãƒ¼ -->
            <div class="user-bar">
                <div class="user-info">
                    <img id="userAvatar" class="user-avatar" src="" alt="User">
                    <div class="user-details">
                        <div class="user-name" id="userName"></div>
                        <div class="user-email" id="userEmail"></div>
                    </div>
                </div>
                <button class="signout-btn" onclick="handleSignoutClick()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
            
            <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ -->
            <div id="messageArea"></div>
            
            <!-- çµ±è¨ˆæƒ…å ± -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">ğŸ“ ç·ä»¶æ•°</div>
                    <div class="stat-value" id="totalCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ğŸ’° åˆè¨ˆé‡‘é¡</div>
                    <div class="stat-value" id="totalAmount">Â¥0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ğŸ“… ä»Šæœˆã®ä»¶æ•°</div>
                    <div class="stat-value" id="monthCount">0</div>
                </div>
            </div>
            
            <!-- é ˜åæ›¸å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div class="main-card">
                <div class="card-title">
                    <span>ğŸ“</span>
                    <span>æ–°ã—ã„é ˜åæ›¸ã‚’ç™»éŒ²</span>
                </div>
                
                <!-- ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
                <div class="form-group">
                    <label>ğŸ“· é ˜åæ›¸ã®å†™çœŸ</label>
                    <div class="image-upload-area" id="uploadArea">
                        <div class="upload-icon">ğŸ“¸</div>
                        <div class="upload-text">ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§ç”»åƒã‚’è¿½åŠ </div>
                        <div class="upload-hint">JPG, PNGå½¢å¼ã«å¯¾å¿œ</div>
                    </div>
                    <input type="file" id="fileInput" accept="image/*" multiple>
                    <div class="image-preview-container" id="imagePreviewContainer"></div>
                </div>
                
                <!-- ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
                <form id="receiptForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="date">æ—¥ä»˜ *</label>
                            <input type="date" id="date" required>
                        </div>
                        <div class="form-group">
                            <label for="store">åº—å/æ”¯æ‰•å…ˆ *</label>
                            <input type="text" id="store" placeholder="ä¾‹: â—‹â—‹ã‚¹ãƒ¼ãƒ‘ãƒ¼" required>
                        </div>
                        <div class="form-group">
                            <label for="amount">é‡‘é¡ *</label>
                            <input type="number" id="amount" placeholder="ä¾‹: 5000" required min="0">
                        </div>
                        <div class="form-group">
                            <label for="category">ã‚«ãƒ†ã‚´ãƒª *</label>
                            <select id="category" required>
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="é£Ÿè²»">é£Ÿè²»</option>
                                <option value="äº¤é€šè²»">äº¤é€šè²»</option>
                                <option value="é€šä¿¡è²»">é€šä¿¡è²»</option>
                                <option value="æ¶ˆè€—å“">æ¶ˆè€—å“</option>
                                <option value="æ¥å¾…äº¤éš›è²»">æ¥å¾…äº¤éš›è²»</option>
                                <option value="ãã®ä»–">ãã®ä»–</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="paymentMethod">æ”¯æ‰•æ–¹æ³•</label>
                            <select id="paymentMethod">
                                <option value="ç¾é‡‘">ç¾é‡‘</option>
                                <option value="ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</option>
                                <option value="é›»å­ãƒãƒãƒ¼">é›»å­ãƒãƒãƒ¼</option>
                                <option value="ãã®ä»–">ãã®ä»–</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="memo">ãƒ¡ãƒ¢</label>
                        <textarea id="memo" placeholder="å‚™è€ƒãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
                    </div>
                    
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">
                            <span>ğŸ’¾</span>
                            <span>ä¿å­˜</span>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">
                            <span>ğŸ”„</span>
                            <span>ã‚¯ãƒªã‚¢</span>
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- é ˜åæ›¸ãƒªã‚¹ãƒˆ -->
            <div class="main-card">
                <div class="card-title">
                    <span>ğŸ“‹</span>
                    <span>ç™»éŒ²æ¸ˆã¿é ˜åæ›¸</span>
                </div>
                
                <div class="btn-group" style="margin-bottom: 1rem;">
                    <button class="btn btn-success" onclick="exportToExcel()">
                        <span>ğŸ“Š</span>
                        <span>Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</span>
                    </button>
                </div>
                
                <div class="receipt-list">
                    <table class="receipt-table">
                        <thead>
                            <tr>
                                <th>ç”»åƒ</th>
                                <th>æ—¥ä»˜</th>
                                <th>åº—å</th>
                                <th>é‡‘é¡</th>
                                <th>ã‚«ãƒ†ã‚´ãƒª</th>
                                <th>æ”¯æ‰•æ–¹æ³•</th>
                                <th>ãƒ¡ãƒ¢</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="receiptTableBody">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                    ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Google APIè¨­å®š
        const CLIENT_ID = '1050370018587-ippasgl5g23v71j4m17qcg9v3f4u1qam.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyA9pY0Eod_0qD9NYaugrSaD9877DmY-sok';
        const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹
        let receipts = [];
        let uploadedImages = [];
        let driveFolder = null;
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        window.addEventListener('load', function() {
            document.getElementById('loginLoading').classList.add('active');
            gapi.load('client:auth2', initClient);
        });
        
        // Google APIåˆæœŸåŒ–
        function initClient() {
            gapi.client.init({
                apiKey: API_KEY,
                clientId: CLIENT_ID,
                discoveryDocs: DISCOVERY_DOCS,
                scope: SCOPES
            }).then(function() {
                // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ç›£è¦–
                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                
                // åˆæœŸçŠ¶æ…‹ã®ç¢ºèª
                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
                
                document.getElementById('loginLoading').classList.remove('active');
            }).catch(function(error) {
                console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('loginLoading').classList.remove('active');
                showMessage('èªè¨¼ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
            });
        }
        
        // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®æ›´æ–°
        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                const user = gapi.auth2.getAuthInstance().currentUser.get();
                const profile = user.getBasicProfile();
                
                document.getElementById('userName').textContent = profile.getName();
                document.getElementById('userEmail').textContent = profile.getEmail();
                document.getElementById('userAvatar').src = profile.getImageUrl();
                
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('appSection').style.display = 'block';
                
                // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
                loadReceipts();
                
                // Google Driveãƒ•ã‚©ãƒ«ãƒ€ã®ç¢ºèª/ä½œæˆ
                initDriveFolder();
            } else {
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('appSection').style.display = 'none';
            }
        }
        
        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        function handleAuthClick() {
            gapi.auth2.getAuthInstance().signIn();
        }
        
        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        function handleSignoutClick() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                gapi.auth2.getAuthInstance().signOut();
            }
        }
        
        // Google Driveãƒ•ã‚©ãƒ«ãƒ€ã®åˆæœŸåŒ–
        async function initDriveFolder() {
            try {
                // æ—¢å­˜ãƒ•ã‚©ãƒ«ãƒ€ã®æ¤œç´¢
                const response = await gapi.client.drive.files.list({
                    q: "name='é ˜åæ›¸ç®¡ç†' and mimeType='application/vnd.google-apps.folder' and trashed=false",
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });
                
                if (response.result.files.length > 0) {
                    driveFolder = response.result.files[0];
                    console.log('æ—¢å­˜ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½¿ç”¨:', driveFolder.id);
                } else {
                    // ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ
                    const createResponse = await gapi.client.drive.files.create({
                        resource: {
                            name: 'é ˜åæ›¸ç®¡ç†',
                            mimeType: 'application/vnd.google-apps.folder'
                        },
                        fields: 'id'
                    });
                    driveFolder = createResponse.result;
                    console.log('æ–°è¦ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ:', driveFolder.id);
                }
            } catch (error) {
                console.error('ãƒ•ã‚©ãƒ«ãƒ€åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–¢é€£
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        
        uploadArea.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', handleFiles);
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles({ target: { files: e.dataTransfer.files } });
        });
        
        // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
        function handleFiles(e) {
            const files = Array.from(e.target.files);
            
            files.forEach(file => {
                if (!file.type.startsWith('image/')) {
                    showMessage('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    uploadedImages.push({
                        file: file,
                        dataUrl: event.target.result
                    });
                    displayImagePreviews();
                };
                reader.readAsDataURL(file);
            });
            
            fileInput.value = '';
        }
        
        // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        function displayImagePreviews() {
            const container = document.getElementById('imagePreviewContainer');
            container.innerHTML = '';
            
            uploadedImages.forEach((img, index) => {
                const div = document.createElement('div');
                div.className = 'image-preview-item';
                div.innerHTML = `
                    <img src="${img.dataUrl}" alt="Preview">
                    <button class="remove-image-btn" onclick="removeImage(${index})">Ã—</button>
                `;
                container.appendChild(div);
            });
        }
        
        // ç”»åƒå‰Šé™¤
        function removeImage(index) {
            uploadedImages.splice(index, 1);
            displayImagePreviews();
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
        document.getElementById('receiptForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const receipt = {
                id: Date.now().toString(),
                date: document.getElementById('date').value,
                store: document.getElementById('store').value,
                amount: parseInt(document.getElementById('amount').value),
                category: document.getElementById('category').value,
                paymentMethod: document.getElementById('paymentMethod').value,
                memo: document.getElementById('memo').value,
                images: [],
                createdAt: new Date().toISOString()
            };
            
            // ç”»åƒã‚’Google Driveã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            if (uploadedImages.length > 0) {
                showMessage('ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...', 'success');
                
                for (const img of uploadedImages) {
                    try {
                        const fileId = await uploadImageToDrive(img.file, receipt.id);
                        receipt.images.push(fileId);
                    } catch (error) {
                        console.error('ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                    }
                }
            }
            
            // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
            receipts.push(receipt);
            saveReceipts();
            
            // è¡¨ç¤ºæ›´æ–°
            displayReceipts();
            updateStats();
            
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            clearForm();
            
            showMessage('é ˜åæ›¸ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼', 'success');
        });
        
        // Google Driveã«ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        async function uploadImageToDrive(file, receiptId) {
            const metadata = {
                name: `receipt_${receiptId}_${Date.now()}.${file.name.split('.').pop()}`,
                mimeType: file.type,
                parents: driveFolder ? [driveFolder.id] : []
            };
            
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);
            
            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + gapi.auth.getToken().access_token
                },
                body: form
            });
            
            const result = await response.json();
            return result.id;
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
        function clearForm() {
            document.getElementById('receiptForm').reset();
            uploadedImages = [];
            displayImagePreviews();
            document.getElementById('date').valueAsDate = new Date();
        }
        
        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜ï¼ˆLocalStorageï¼‰
        function saveReceipts() {
            localStorage.setItem('receipts', JSON.stringify(receipts));
        }
        
        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadReceipts() {
            const saved = localStorage.getItem('receipts');
            if (saved) {
                receipts = JSON.parse(saved);
                displayReceipts();
                updateStats();
            }
        }
        
        // é ˜åæ›¸è¡¨ç¤º
        function displayReceipts() {
            const tbody = document.getElementById('receiptTableBody');
            
            if (receipts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
                        </td>
                    </tr>
                `;
                return;
            }
            
            // æ—¥ä»˜é †ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
            const sortedReceipts = [...receipts].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = sortedReceipts.map(receipt => `
                <tr>
                    <td>
                        ${receipt.images.length > 0 ? 
                            `<img src="https://drive.google.com/thumbnail?id=${receipt.images[0]}&sz=w200" 
                                  class="receipt-image-thumb" 
                                  onclick="viewImage('${receipt.images[0]}')" 
                                  onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22><text x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2240%22>ğŸ“·</text></svg>'"
                                  alt="é ˜åæ›¸">` 
                            : 'ğŸ“·'}
                    </td>
                    <td>${receipt.date}</td>
                    <td>${receipt.store}</td>
                    <td>Â¥${receipt.amount.toLocaleString()}</td>
                    <td>${receipt.category}</td>
                    <td>${receipt.paymentMethod}</td>
                    <td>${receipt.memo || '-'}</td>
                    <td>
                        <button class="delete-receipt-btn" onclick="deleteReceipt('${receipt.id}')">å‰Šé™¤</button>
                    </td>
                </tr>
            `).join('');
        }
        
        // ç”»åƒè¡¨ç¤º
        function viewImage(fileId) {
            window.open(`https://drive.google.com/file/d/${fileId}/view`, '_blank');
        }
        
        // é ˜åæ›¸å‰Šé™¤
        function deleteReceipt(id) {
            if (confirm('ã“ã®é ˜åæ›¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                receipts = receipts.filter(r => r.id !== id);
                saveReceipts();
                displayReceipts();
                updateStats();
                showMessage('é ˜åæ›¸ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚', 'success');
            }
        }
        
        // çµ±è¨ˆæƒ…å ±æ›´æ–°
        function updateStats() {
            const total = receipts.length;
            const totalAmount = receipts.reduce((sum, r) => sum + r.amount, 0);
            
            const now = new Date();
            const currentMonth = receipts.filter(r => {
                const receiptDate = new Date(r.date);
                return receiptDate.getMonth() === now.getMonth() && 
                       receiptDate.getFullYear() === now.getFullYear();
            }).length;
            
            document.getElementById('totalCount').textContent = total;
            document.getElementById('totalAmount').textContent = 'Â¥' + totalAmount.toLocaleString();
            document.getElementById('monthCount').textContent = currentMonth;
        }
        
        // Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportToExcel() {
            if (receipts.length === 0) {
                showMessage('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'error');
                return;
            }
            
            // ãƒ‡ãƒ¼ã‚¿æ•´å½¢
            const data = receipts.map(r => ({
                'æ—¥ä»˜': r.date,
                'åº—å': r.store,
                'é‡‘é¡': r.amount,
                'ã‚«ãƒ†ã‚´ãƒª': r.category,
                'æ”¯æ‰•æ–¹æ³•': r.paymentMethod,
                'ãƒ¡ãƒ¢': r.memo || '',
                'ç™»éŒ²æ—¥æ™‚': new Date(r.createdAt).toLocaleString('ja-JP')
            }));
            
            // ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ä½œæˆ
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(data);
            
            // åˆ—å¹…è¨­å®š
            ws['!cols'] = [
                { wch: 12 },  // æ—¥ä»˜
                { wch: 20 },  // åº—å
                { wch: 10 },  // é‡‘é¡
                { wch: 12 },  // ã‚«ãƒ†ã‚´ãƒª
                { wch: 15 },  // æ”¯æ‰•æ–¹æ³•
                { wch: 30 },  // ãƒ¡ãƒ¢
                { wch: 20 }   // ç™»éŒ²æ—¥æ™‚
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'é ˜åæ›¸ä¸€è¦§');
            
            // ãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ
            const fileName = `é ˜åæ›¸ãƒ‡ãƒ¼ã‚¿_${new Date().toISOString().split('T')[0]}.xlsx`;
            
            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            XLSX.writeFile(wb, fileName);
            
            showMessage('Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼', 'success');
        }
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showMessage(text, type) {
            const messageArea = document.getElementById('messageArea');
            const message = document.createElement('div');
            message.className = `message ${type} show`;
            message.textContent = text;
            
            messageArea.innerHTML = '';
            messageArea.appendChild(message);
            
            setTimeout(() => {
                message.classList.remove('show');
                setTimeout(() => message.remove(), 300);
            }, 3000);
        }
        
        // åˆæœŸåŒ–ï¼šä»Šæ—¥ã®æ—¥ä»˜ã‚’ã‚»ãƒƒãƒˆ
        document.getElementById('date').valueAsDate = new Date();
    </script>
</body>
</html>