<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>È†òÂèéÊõ∏ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É† - Google DriveÈÄ£Êê∫</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;600;700&family=Outfit:wght@600;800&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #2d5a8c;
            --secondary: #4a90e2;
            --accent: #ff6b6b;
            --success: #51cf66;
            --warning: #ffd93d;
            --google: #4285f4;
            --bg-card: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #6c757d;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 1.5rem 1rem;
            color: var(--text-primary);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        
        .header h1 {
            font-family: 'Outfit', sans-serif;
            font-weight: 800;
            font-size: 2.2rem;
            color: white;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            margin-bottom: 0.5rem;
        }
        
        .header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.95rem;
        }
        
        .login-card {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            max-width: 500px;
            margin: 3rem auto;
            text-align: center;
            box-shadow: var(--shadow);
        }
        
        .login-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
        }
        
        .login-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }
        
        .login-description {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            line-height: 1.6;
        }
        
        .google-signin-btn {
            display: inline-flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 2rem;
            background: var(--google);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
        }
        
        .google-signin-btn:hover {
            background: #3367d6;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
        }
        
        .user-bar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 2px solid var(--google);
        }
        
        .user-details {
            display: flex;
            flex-direction: column;
        }
        
        .user-name {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .user-email {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .signout-btn {
            padding: 0.6rem 1.2rem;
            background: #ea4335;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .tabs {
            display: flex;
            gap: 0.8rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 0.9rem 1.8rem;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-family: 'Noto Sans JP', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .tab.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(74, 144, 226, 0.4);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .main-card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
        }
        
        .section-title {
            font-family: 'Outfit', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .upload-area {
            border: 3px dashed var(--secondary);
            border-radius: 16px;
            padding: 2.5rem 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, rgba(74, 144, 226, 0.05) 0%, rgba(102, 126, 234, 0.05) 100%);
        }
        
        .upload-area:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(74, 144, 226, 0.1) 0%, rgba(102, 126, 234, 0.1) 100%);
        }
        
        .upload-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--secondary);
        }
        
        .upload-text {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.4rem;
        }
        
        .upload-hint {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        #fileInput {
            display: none;
        }
        
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1.2rem;
        }
        
        .preview-item {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .preview-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
        }
        
        .preview-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        
        .remove-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            background: rgba(255, 107, 107, 0.95);
            color: white;
            border: none;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.8rem;
            margin-top: 1.2rem;
            flex-wrap: wrap;
        }
        
        .btn {
            flex: 1;
            min-width: 160px;
            padding: 0.85rem 1.3rem;
            border: none;
            border-radius: 10px;
            font-family: 'Noto Sans JP', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 16px rgba(74, 144, 226, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #40c057 0%, #51cf66 100%);
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 16px rgba(81, 207, 102, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #868e96 0%, #495057 100%);
            color: white;
        }
        
        .btn-secondary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 16px rgba(134, 142, 150, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .month-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .month-selector select {
            padding: 0.7rem 1.1rem;
            border: 2px solid var(--secondary);
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: 'Noto Sans JP', sans-serif;
            cursor: pointer;
            background: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            border-radius: 12px;
            padding: 1.2rem;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.4rem;
        }
        
        .stat-value {
            font-family: 'Outfit', sans-serif;
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .receipt-list {
            display: flex;
            flex-direction: column;
            gap: 0.7rem;
        }
        
        .receipt-card {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 1rem;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .receipt-card:hover {
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.12);
            transform: translateX(3px);
        }
        
        .receipt-thumb {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            cursor: pointer;
        }
        
        .receipt-info {
            flex: 1;
        }
        
        .receipt-store {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 0.3rem;
        }
        
        .receipt-details {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .confidence-stars {
            color: #ffd700;
            font-size: 0.85rem;
            letter-spacing: 1px;
        }
        
        .category-badge {
            display: inline-block;
            padding: 0.35rem 0.9rem;
            border-radius: 16px;
            font-weight: 600;
            font-size: 0.85rem;
            white-space: nowrap;
        }
        
        .category-gas { background: #fff3e0; color: #e65100; }
        .category-food { background: #fce4ec; color: #c2185b; }
        .category-transport { background: #e3f2fd; color: #1565c0; }
        .category-supplies { background: #f3e5f5; color: #6a1b9a; }
        .category-souvenir { background: #ffe0f0; color: #d81b60; }
        .category-taxi { background: #fff9c4; color: #f57f17; }
        .category-parking { background: #e0f2f1; color: #00695c; }
        .category-golf { background: #e8f5e9; color: #2e7d32; }
        .category-materials { background: #e1f5fe; color: #01579b; }
        .category-other { background: #f5f5f5; color: #616161; }
        
        .receipt-amount {
            font-family: 'Outfit', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            text-align: right;
        }
        
        .loading {
            text-align: center;
            padding: 2.5rem;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(74, 144, 226, 0.2);
            border-top-color: var(--secondary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .drive-info {
            background: #e8f4fd;
            border-left: 4px solid var(--google);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }
        
        .drive-info strong {
            color: var(--google);
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }
            .main-card {
                padding: 1.5rem;
            }
            .receipt-card {
                grid-template-columns: 1fr;
                text-align: center;
            }
            .receipt-thumb {
                margin: 0 auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä È†òÂèéÊõ∏ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</h1>
            <p>Google DriveÈÄ£Êê∫ - Ê®™Êµú„ÉªÈ´òÁü•„Å©„Åì„Åã„Çâ„Åß„ÇÇ„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩ</p>
        </div>
        
        <div id="loginSection">
            <div class="login-card">
                <div class="login-icon">üîê</div>
                <div class="login-title">Google„Ç¢„Ç´„Ç¶„É≥„Éà„Åß„É≠„Ç∞„Ç§„É≥</div>
                <div class="login-description">
                    Google Drive„Å´Êé•Á∂ö„Åó„Å¶„ÄÅÈ†òÂèéÊõ∏„ÇíÂÆâÂÖ®„Å´‰øùÂ≠ò„ÉªÁÆ°ÁêÜ„Åó„Åæ„Åô„ÄÇ<br>
                    Ê®™Êµú„Å®È´òÁü•„ÄÅ„Å©„Åì„Åã„Çâ„Åß„ÇÇÂêå„Åò„Éá„Éº„Çø„Å´„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Åæ„Åô„ÄÇ
                </div>
                <button class="google-signin-btn" onclick="handleAuthClick()">
                    <span>üîµ</span>
                    <span>Google„Åß„É≠„Ç∞„Ç§„É≥</span>
                </button>
            </div>
        </div>
        
        <div id="appSection" style="display: none;">
            <div class="user-bar">
                <div class="user-info">
                    <img id="userAvatar" class="user-avatar" src="" alt="User">
                    <div class="user-details">
                        <div class="user-name" id="userName"></div>
                        <div class="user-email" id="userEmail"></div>
                    </div>
                </div>
                <button class="signout-btn" onclick="handleSignoutClick()">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="switchTab('upload')">üì∏ Êñ∞Ë¶èÁôªÈå≤</button>
                <button class="tab" onclick="switchTab('monthly')">üìÖ ÊúàÂà•ÁÆ°ÁêÜ</button>
                <button class="tab" onclick="switchTab('export')">üì• Âá∫Âäõ</button>
            </div>
            
            <div id="uploadTab" class="tab-content active">
                <div class="main-card">
                    <div class="drive-info">
                        <strong>üíæ ‰øùÂ≠òÂÖà:</strong> Google Drive > È†òÂèéÊõ∏ÁÆ°ÁêÜ > 2026Âπ¥02Êúà
                    </div>
                    
                    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                        <div class="upload-icon">üì∏</div>
                        <div class="upload-text">È†òÂèéÊõ∏„ÇíÊíÆÂΩ±„Éª„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</div>
                        <div class="upload-hint">„ÇØ„É™„ÉÉ„ÇØ„Åæ„Åü„ÅØ„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó</div>
                    </div>
                    <input type="file" id="fileInput" accept="image/*" multiple capture="environment">
                    
                    <div id="previewContainer" class="preview-grid"></div>
                    
                    <div class="action-buttons">
                        <button id="analyzeBtn" class="btn btn-primary" disabled onclick="analyzeReceipts()">
                            <span>üîç</span>
                            <span>AIÂàÜÊûê„ÇíÈñãÂßã</span>
                        </button>
                        <button id="saveToDriveBtn" class="btn btn-success" disabled onclick="saveToDrive()">
                            <span>‚òÅÔ∏è</span>
                            <span>Google Drive„Å´‰øùÂ≠ò</span>
                        </button>
                    </div>
                </div>
                
                <div id="resultsSection" style="display: none;">
                    <div class="main-card">
                        <div class="section-title">
                            <span>üìã</span>
                            <span>ÂàÜÊûêÁµêÊûú</span>
                        </div>
                        <div id="resultsList" class="receipt-list"></div>
                    </div>
                </div>
            </div>
            
            <div id="monthlyTab" class="tab-content">
                <div class="main-card">
                    <div class="month-selector">
                        <label><strong>üìÖ Ë°®Á§∫Êúà:</strong></label>
                        <select id="yearSelect" onchange="loadMonthlyData()"></select>
                        <select id="monthSelect" onchange="loadMonthlyData()"></select>
                        <button class="btn btn-secondary" style="min-width: auto; padding: 0.7rem 1.2rem;" onclick="loadMonthlyData()">
                            üîÑ Êõ¥Êñ∞
                        </button>
                    </div>
                    
                    <div id="statsGrid" class="stats-grid"></div>
                    
                    <div class="section-title">
                        <span>üìã</span>
                        <span>È†òÂèéÊõ∏‰∏ÄË¶ß</span>
                    </div>
                    <div id="monthlyList" class="receipt-list"></div>
                </div>
            </div>
            
            <div id="exportTab" class="tab-content">
                <div class="main-card">
                    <div class="section-title">
                        <span>üì•</span>
                        <span>„Éá„Éº„ÇøÂá∫Âäõ</span>
                    </div>
                    
                    <div class="month-selector">
                        <label><strong>üìÖ Âá∫ÂäõÂØæË±°:</strong></label>
                        <select id="exportYearSelect"></select>
                        <select id="exportMonthSelect"></select>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="exportToExcel()">
                            <span>üìä</span>
                            <span>ExcelÂá∫Âäõ</span>
                        </button>
                        <button class="btn btn-secondary" onclick="downloadCategorizedImages()">
                            <span>üìÅ</span>
                            <span>„Ç´„ÉÜ„Ç¥„É™Âà•ÁîªÂÉèZIP</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="loadingSection" style="display: none;">
                <div class="main-card">
                    <div class="loading">
                        <div class="spinner"></div>
                        <div id="loadingText">Âá¶ÁêÜ‰∏≠...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Google APIË®≠ÂÆö
        const CLIENT_ID = 'YOUR_CLIENT_ID.apps.googleusercontent.com'; // ‚Üê „Åì„Åì„Å´„ÇØ„É©„Ç§„Ç¢„É≥„ÉàID„ÇíË®≠ÂÆö
        const API_KEY = 'YOUR_API_KEY'; // ‚Üê „Åì„Åì„Å´API„Ç≠„Éº„ÇíË®≠ÂÆö
        const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        
        let uploadedFiles = [];
        let processedReceipts = [];
        let currentUser = null;
        let rootFolderId = null;
        
        const CLIENT_ID = '1050370018587-ippasgl5g23v71j4m17qcg9v3f4u1qam.apps.googleusercontent.com';
const API_KEY = '';
            'food': { name: 'È£≤È£üË≤ª', class: 'category-food', icon: 'üçΩÔ∏è' },
            'transport': { name: '‰∫§ÈÄöË≤ª', class: 'category-transport', icon: 'üöÉ' },
            'supplies': { name: 'Ê∂àËÄóÂìÅ„ÉªÊñáÊàøÂÖ∑', class: 'category-supplies', icon: '‚úèÔ∏è' },
            'souvenir': { name: 'ÂúüÁî£', class: 'category-souvenir', icon: 'üéÅ' },
            'taxi': { name: '„Çø„ÇØ„Ç∑„Éº', class: 'category-taxi', icon: 'üöñ' },
            'parking': { name: 'ÈßêËªäÂ†¥', class: 'category-parking', icon: 'üÖøÔ∏è' },
            'golf': { name: '„Ç¥„É´„Éï', class: 'category-golf', icon: '‚õ≥' },
            'materials': { name: 'Ë≥áÊùê', class: 'category-materials', icon: 'üîß' },
            'other': { name: '„Åù„ÅÆ‰ªñ', class: 'category-other', icon: 'üì¶' }
        };
        
        // Google APIÂàùÊúüÂåñ
        function gapiLoad() {
            gapi.load('client:auth2', initClient);
        }
        
        function initClient() {
            gapi.client.init({
                apiKey: API_KEY,
                clientId: CLIENT_ID,
                discoveryDocs: DISCOVERY_DOCS,
                scope: SCOPES
            }).then(() => {
                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
            });
        }
        
        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                const user = gapi.auth2.getAuthInstance().currentUser.get();
                const profile = user.getBasicProfile();
                currentUser = {
                    id: profile.getId(),
                    name: profile.getName(),
                    email: profile.getEmail(),
                    imageUrl: profile.getImageUrl()
                };
                
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userEmail').textContent = currentUser.email;
                document.getElementById('userAvatar').src = currentUser.imageUrl;
                
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('appSection').style.display = 'block';
                
                initializeFolders();
                initializeSelects();
            } else {
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('appSection').style.display = 'none';
            }
        }
        
        function handleAuthClick() {
            gapi.auth2.getAuthInstance().signIn();
        }
        
        function handleSignoutClick() {
            gapi.auth2.getAuthInstance().signOut();
        }
        
        // „Éï„Ç©„É´„ÉÄÊßãÈÄ†„ÅÆÂàùÊúüÂåñ
        async function initializeFolders() {
            try {
                // „É´„Éº„Éà„Éï„Ç©„É´„ÉÄ„ÄåÈ†òÂèéÊõ∏ÁÆ°ÁêÜ„Äç„Çí‰ΩúÊàê„Åæ„Åü„ÅØÂèñÂæó
                const response = await gapi.client.drive.files.list({
                    q: "name='È†òÂèéÊõ∏ÁÆ°ÁêÜ' and mimeType='application/vnd.google-apps.folder' and trashed=false",
                    fields: 'files(id, name)'
                });
                
                if (response.result.files.length > 0) {
                    rootFolderId = response.result.files[0].id;
                } else {
                    const folder = await gapi.client.drive.files.create({
                        resource: {
                            name: 'È†òÂèéÊõ∏ÁÆ°ÁêÜ',
                            mimeType: 'application/vnd.google-apps.folder'
                        },
                        fields: 'id'
                    });
                    rootFolderId = folder.result.id;
                }
            } catch (error) {
                console.error('„Éï„Ç©„É´„ÉÄÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
            }
        }
        
        // Âπ¥Êúà„Éï„Ç©„É´„ÉÄ„ÇíÂèñÂæó„Åæ„Åü„ÅØ‰ΩúÊàê
        async function getOrCreateMonthFolder(year, month) {
            // Âπ¥„Éï„Ç©„É´„ÉÄ
            const yearName = `${year}Âπ¥`;
            let yearFolderId;
            
            const yearResponse = await gapi.client.drive.files.list({
                q: `name='${yearName}' and '${rootFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                fields: 'files(id)'
            });
            
            if (yearResponse.result.files.length > 0) {
                yearFolderId = yearResponse.result.files[0].id;
            } else {
                const yearFolder = await gapi.client.drive.files.create({
                    resource: {
                        name: yearName,
                        mimeType: 'application/vnd.google-apps.folder',
                        parents: [rootFolderId]
                    },
                    fields: 'id'
                });
                yearFolderId = yearFolder.result.id;
            }
            
            // Êúà„Éï„Ç©„É´„ÉÄ
            const monthName = `${String(month).padStart(2, '0')}Êúà`;
            const monthResponse = await gapi.client.drive.files.list({
                q: `name='${monthName}' and '${yearFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                fields: 'files(id)'
            });
            
            if (monthResponse.result.files.length > 0) {
                return monthResponse.result.files[0].id;
            } else {
                const monthFolder = await gapi.client.drive.files.create({
                    resource: {
                        name: monthName,
                        mimeType: 'application/vnd.google-apps.folder',
                        parents: [yearFolderId]
                    },
                    fields: 'id'
                });
                return monthFolder.result.id;
            }
        }
        
        // „Ç´„ÉÜ„Ç¥„É™„Éï„Ç©„É´„ÉÄ„ÇíÂèñÂæó„Åæ„Åü„ÅØ‰ΩúÊàê
        async function getOrCreateCategoryFolder(monthFolderId, categoryName) {
            const response = await gapi.client.drive.files.list({
                q: `name='${categoryName}' and '${monthFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                fields: 'files(id)'
            });
            
            if (response.result.files.length > 0) {
                return response.result.files[0].id;
            } else {
                const folder = await gapi.client.drive.files.create({
                    resource: {
                        name: categoryName,
                        mimeType: 'application/vnd.google-apps.folder',
                        parents: [monthFolderId]
                    },
                    fields: 'id'
                });
                return folder.result.id;
            }
        }
        
        // „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂá¶ÁêÜ
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const analyzeBtn = document.getElementById('analyzeBtn');
        
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleFiles(files);
        });
        
        function handleFiles(files) {
            files.forEach(file => {
                uploadedFiles.push(file);
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.createElement('div');
                    preview.className = 'preview-item';
                    preview.innerHTML = `
                        <img src="${e.target.result}" alt="Receipt">
                        <button class="remove-btn" onclick="removeFile(${uploadedFiles.length - 1})">√ó</button>
                    `;
                    previewContainer.appendChild(preview);
                };
                reader.readAsDataURL(file);
            });
            
            analyzeBtn.disabled = uploadedFiles.length === 0;
        }
        
        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            updatePreviews();
            analyzeBtn.disabled = uploadedFiles.length === 0;
        }
        
        function updatePreviews() {
            previewContainer.innerHTML = '';
            uploadedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.createElement('div');
                    preview.className = 'preview-item';
                    preview.innerHTML = `
                        <img src="${e.target.result}" alt="Receipt">
                        <button class="remove-btn" onclick="removeFile(${index})">√ó</button>
                    `;
                    previewContainer.appendChild(preview);
                };
                reader.readAsDataURL(file);
            });
        }
        
        // AIÂàÜÊûê
        async function analyzeReceipts() {
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('loadingText').textContent = 'AI„ÅåÈ†òÂèéÊõ∏„ÇíÂàÜÊûê‰∏≠...';
            analyzeBtn.disabled = true;
            
            processedReceipts = [];
            
            for (let i = 0; i < uploadedFiles.length; i++) {
                const file = uploadedFiles[i];
                const base64 = await fileToBase64(file);
                
                try {
                    const result = await analyzeReceipt(base64, file.name);
                    processedReceipts.push(result);
                } catch (error) {
                    console.error('ÂàÜÊûê„Ç®„É©„Éº:', error);
                    processedReceipts.push({
                        filename: file.name,
                        store: 'Ë™≠„ÅøÂèñ„ÇäÂ§±Êïó',
                        date: new Date().toISOString().split('T')[0],
                        amount: 0,
                        category: 'other',
                        confidence: 1,
                        invoice_number: ''
                    });
                }
            }
            
            displayResults();
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('saveToDriveBtn').disabled = false;
            analyzeBtn.disabled = false;
        }
        
        function fileToBase64(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(file);
            });
        }
        
        async function analyzeReceipt(base64Image, filename) {
            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 1000,
                    messages: [{
                        role: 'user',
                        content: [
                            {
                                type: 'image',
                                source: {
                                    type: 'base64',
                                    media_type: 'image/jpeg',
                                    data: base64Image
                                }
                            },
                            {
                                type: 'text',
                                text: `„Åì„ÅÆÈ†òÂèéÊõ∏ÁîªÂÉè„Åã„Çâ‰ª•‰∏ã„ÅÆÊÉÖÂ†±„ÇíÊäΩÂá∫„Åó„ÄÅJSONÂΩ¢Âºè„ÅßËøî„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊó•Êú¨Ë™û„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÇíÊ≠£Á¢∫„Å´Ë™≠„ÅøÂèñ„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

ÂøÖ„Åö‰ª•‰∏ã„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÅßËøî„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö
{
  "store": "Â∫óËàóÂêç",
  "date": "Êó•‰ªò(YYYY-MM-DDÂΩ¢Âºè)",
  "amount": ÈáëÈ°ç(Êï∞ÂÄ§„ÅÆ„Åø),
  "category": "gas/food/transport/supplies/souvenir/taxi/parking/golf/materials/other „ÅÆ„ÅÑ„Åö„Çå„Åã",
  "confidence": 1„Åã„Çâ5„ÅÆÊï¥Êï∞(5„ÅåÊúÄ„ÇÇÁ¢∫‰ø°Â∫¶„ÅåÈ´ò„ÅÑ),
  "invoice_number": "T+13Ê°Å„ÅÆÊï∞Â≠óÔºàË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØÁ©∫ÊñáÂ≠óÔºâ"
}

„Ç´„ÉÜ„Ç¥„É™„ÅÆÂà§ÂÆöÂü∫Ê∫ñÔºö
- gas: „Ç¨„ÇΩ„É™„É≥„Çπ„Çø„É≥„Éâ„ÄÅÁáÉÊñô‰ª£
- food: „É¨„Çπ„Éà„É©„É≥„ÄÅ„Ç´„Éï„Çß„ÄÅ„Ç≥„É≥„Éì„Éã„Åß„ÅÆÈ£≤È£üÁâ©
- transport: ÈõªËªä„ÄÅ„Éê„Çπ„ÄÅÈ´òÈÄüÈÅìË∑ØÊñôÈáë„Å™„Å©
- supplies: ÊñáÊàøÂÖ∑„ÄÅ‰∫ãÂãôÁî®ÂìÅ„ÄÅÊ∂àËÄóÂìÅ
- souvenir: ÂúüÁî£Áâ©„ÄÅ„ÇÆ„Éï„Éà„ÄÅË¥àÁ≠îÂìÅ
- taxi: „Çø„ÇØ„Ç∑„Éº‰ª£
- parking: ÈßêËªäÂ†¥‰ª£
- golf: „Ç¥„É´„ÉïÂ†¥„ÄÅ„Ç¥„É´„ÉïÁî®ÂìÅ
- materials: Âª∫ÁØâË≥áÊùê„ÄÅÂ∑•ÂÖ∑„ÄÅÂª∫Êùê
- other: ‰∏äË®ò‰ª•Â§ñ

Á¢∫‰ø°Â∫¶„ÅÆÂà§ÂÆöÂü∫Ê∫ñÔºö
- 5: Â∫óËàóÂêç„ÇÑÂïÜÂìÅÂêç„Åã„ÇâÊòéÁ¢∫„Å´„Ç´„ÉÜ„Ç¥„É™„ÅåÂà§Êñ≠„Åß„Åç„Çã
- 4: „Åª„ÅºÁ¢∫ÂÆü„Å†„Åå„ÄÅËã•Âπ≤„ÅÆÊõñÊòß„Åï„Åå„ÅÇ„Çã
- 3: Êé®Ê∏¨„Å†„ÅåÂ¶•ÂΩì„Å®ÊÄù„Çè„Çå„Çã
- 2: ‰∏çÊòéÁû≠„Å†„ÅåÂèØËÉΩÊÄß„ÅåÈ´ò„ÅÑ
- 1: Âà§Êñ≠„ÅåÂõ∞Èõ£„ÄÅ„Åù„ÅÆ‰ªñ„ÅÆÂèØËÉΩÊÄß„ÇÇÈ´ò„ÅÑ

ÁôªÈå≤Áï™Âè∑„Å´„Å§„ÅÑ„Å¶Ôºö
- „ÄåÁôªÈå≤Áï™Âè∑„Äç„ÄåÈÅ©Ê†ºË´ãÊ±ÇÊõ∏Áô∫Ë°å‰∫ãÊ•≠ËÄÖ„Äç„Å™„Å©„ÅÆË°®Ë®ò„ÅÆËøë„Åè„Å´„ÅÇ„Çã„ÄåT„Äç„Åã„ÇâÂßã„Åæ„Çã13Ê°Å„ÅÆÁï™Âè∑„ÇíÊäΩÂá∫
- Ë¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØÁ©∫ÊñáÂ≠ó""„ÇíËøî„Åô

JSONÂΩ¢Âºè„ÅÆ„Åø„ÇíËøî„Åó„ÄÅ‰ªñ„ÅÆË™¨Êòé„ÅØ‰∏çË¶Å„Åß„Åô„ÄÇ`
                            }
                        ]
                    }]
                })
            });
            
            const data = await response.json();
            const textContent = data.content.find(c => c.type === 'text')?.text || '{}';
            const jsonMatch = textContent.match(/\{[\s\S]*\}/);
            const jsonStr = jsonMatch ? jsonMatch[0] : textContent;
            
            try {
                const parsed = JSON.parse(jsonStr);
                return {
                    filename,
                    ...parsed
                };
            } catch (e) {
                return {
                    filename,
                    store: '‰∏çÊòé',
                    date: new Date().toISOString().split('T')[0],
                    amount: 0,
                    category: 'other',
                    confidence: 1,
                    invoice_number: ''
                };
            }
        }
        
        function displayResults() {
            const listHTML = processedReceipts.map((receipt, index) => {
                const catInfo = categories[receipt.category] || categories.other;
                const imgSrc = URL.createObjectURL(uploadedFiles[index]);
                const confidence = receipt.confidence || 3;
                const stars = '‚òÖ'.repeat(confidence) + '‚òÜ'.repeat(5 - confidence);
                const invoiceNum = receipt.invoice_number || '';
                const invoiceDisplay = invoiceNum ? `<span>üî¢ ${invoiceNum}</span>` : '';
                
                return `
                    <div class="receipt-card">
                        <img src="${imgSrc}" alt="Receipt" class="receipt-thumb">
                        <div class="receipt-info">
                            <div class="receipt-store">${receipt.store}</div>
                            <div class="receipt-details">
                                <span>üìÖ ${receipt.date}</span>
                                ${invoiceDisplay}
                                <span class="confidence-stars" title="‰ªïÂàÜ„ÅëÁ¢∫‰ø°Â∫¶: ${confidence}/5">${stars}</span>
                            </div>
                        </div>
                        <div>
                            <div class="category-badge ${catInfo.class}">
                                ${catInfo.icon} ${catInfo.name}
                            </div>
                            <div class="receipt-amount">¬•${receipt.amount.toLocaleString()}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('resultsList').innerHTML = listHTML;
        }
        
        // Google Drive„Å´‰øùÂ≠ò
        async function saveToDrive() {
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('loadingText').textContent = 'Google Drive„Å´‰øùÂ≠ò‰∏≠...';
            document.getElementById('saveToDriveBtn').disabled = true;
            
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            
            try {
                const monthFolderId = await getOrCreateMonthFolder(year, month);
                
                // „Ç´„ÉÜ„Ç¥„É™Âà•„Å´„Éï„Ç°„Ç§„É´„Çí‰øùÂ≠ò
                for (let i = 0; i < processedReceipts.length; i++) {
                    const receipt = processedReceipts[i];
                    const file = uploadedFiles[i];
                    const catInfo = categories[receipt.category] || categories.other;
                    
                    const categoryFolderId = await getOrCreateCategoryFolder(monthFolderId, catInfo.name);
                    
                    // „Éï„Ç°„Ç§„É´Âêç: Êó•‰ªò_Â∫óËàóÂêç_ÈáëÈ°çÂÜÜ.Êã°ÂºµÂ≠ê
                    const ext = file.name.split('.').pop();
                    const sanitizedStore = receipt.store.replace(/[\/\\:*?"<>|]/g, '_');
                    const fileName = `${receipt.date}_${sanitizedStore}_${receipt.amount}ÂÜÜ.${ext}`;
                    
                    // „Éï„Ç°„Ç§„É´„ÇíBase64„Å´Â§âÊèõ
                    const base64 = await fileToBase64(file);
                    
                    // Google Drive„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
                    const metadata = {
                        name: fileName,
                        parents: [categoryFolderId],
                        description: JSON.stringify({
                            store: receipt.store,
                            date: receipt.date,
                            amount: receipt.amount,
                            category: receipt.category,
                            confidence: receipt.confidence,
                            invoice_number: receipt.invoice_number
                        })
                    };
                    
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', file);
                    
                    await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: new Headers({ 'Authorization': 'Bearer ' + gapi.auth.getToken().access_token }),
                        body: form
                    });
                }
                
                alert('‚úÖ Google Drive„Å´‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
                
                // „É™„Çª„ÉÉ„Éà
                uploadedFiles = [];
                processedReceipts = [];
                previewContainer.innerHTML = '';
                document.getElementById('resultsSection').style.display = 'none';
                analyzeBtn.disabled = true;
                document.getElementById('saveToDriveBtn').disabled = true;
                
            } catch (error) {
                console.error('‰øùÂ≠ò„Ç®„É©„Éº:', error);
                alert('‚ùå ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
            
            document.getElementById('loadingSection').style.display = 'none';
        }
        
        // „Çø„ÉñÂàá„ÇäÊõø„Åà
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            if (tabName === 'monthly') {
                loadMonthlyData();
            }
        }
        
        // Âπ¥Êúà„Çª„É¨„ÇØ„Éà„ÅÆÂàùÊúüÂåñ
        function initializeSelects() {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1;
            
            // Âπ¥„Çª„É¨„ÇØ„Éà
            const yearSelects = [document.getElementById('yearSelect'), document.getElementById('exportYearSelect')];
            yearSelects.forEach(select => {
                for (let y = currentYear; y >= currentYear - 3; y--) {
                    const option = document.createElement('option');
                    option.value = y;
                    option.textContent = `${y}Âπ¥`;
                    select.appendChild(option);
                }
            });
            
            // Êúà„Çª„É¨„ÇØ„Éà
            const monthSelects = [document.getElementById('monthSelect'), document.getElementById('exportMonthSelect')];
            monthSelects.forEach(select => {
                for (let m = 1; m <= 12; m++) {
                    const option = document.createElement('option');
                    option.value = m;
                    option.textContent = `${m}Êúà`;
                    if (m === currentMonth) option.selected = true;
                    select.appendChild(option);
                }
            });
        }
        
        // ÊúàÂà•„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø
        async function loadMonthlyData() {
            const year = document.getElementById('yearSelect').value;
            const month = document.getElementById('monthSelect').value;
            
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('loadingText').textContent = `${year}Âπ¥${month}Êúà„ÅÆ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...`;
            
            try {
                const monthFolderId = await getOrCreateMonthFolder(year, month);
                
                // „Ç´„ÉÜ„Ç¥„É™„Éï„Ç©„É´„ÉÄÂÜÖ„ÅÆ„Éï„Ç°„Ç§„É´„ÇíÂèñÂæó
                const receipts = [];
                
                for (const [key, catInfo] of Object.entries(categories)) {
                    const categoryFolderId = await getOrCreateCategoryFolder(monthFolderId, catInfo.name);
                    
                    const response = await gapi.client.drive.files.list({
                        q: `'${categoryFolderId}' in parents and trashed=false`,
                        fields: 'files(id, name, description, thumbnailLink, webContentLink)',
                        orderBy: 'name'
                    });
                    
                    response.result.files.forEach(file => {
                        try {
                            const desc = JSON.parse(file.description || '{}');
                            receipts.push({
                                ...desc,
                                filename: file.name,
                                fileId: file.id,
                                thumbnailLink: file.thumbnailLink,
                                webContentLink: file.webContentLink
                            });
                        } catch (e) {
                            console.error('„Éï„Ç°„Ç§„É´„Éá„Éº„ÇøËß£Êûê„Ç®„É©„Éº:', e);
                        }
                    });
                }
                
                // Áµ±Ë®àË°®Á§∫
                displayStats(receipts);
                
                // „É™„Çπ„ÉàË°®Á§∫
                displayMonthlyList(receipts);
                
            } catch (error) {
                console.error('„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
            }
            
            document.getElementById('loadingSection').style.display = 'none';
        }
        
        function displayStats(receipts) {
            const stats = {};
            let total = 0;
            
            Object.keys(categories).forEach(cat => {
                stats[cat] = { total: 0, count: 0 };
            });
            
            receipts.forEach(r => {
                const cat = r.category || 'other';
                stats[cat].total += r.amount || 0;
                stats[cat].count += 1;
                total += r.amount || 0;
            });
            
            const statsHTML = Object.entries(stats)
                .filter(([, data]) => data.count > 0)
                .map(([key, data]) => {
                    const catInfo = categories[key];
                    return `
                        <div class="stat-card">
                            <div class="stat-label">${catInfo.icon} ${catInfo.name}</div>
                            <div class="stat-value">¬•${data.total.toLocaleString()}</div>
                            <div class="stat-label">${data.count}‰ª∂</div>
                        </div>
                    `;
                }).join('');
            
            document.getElementById('statsGrid').innerHTML = statsHTML;
        }
        
        function displayMonthlyList(receipts) {
            const listHTML = receipts.map(receipt => {
                const catInfo = categories[receipt.category] || categories.other;
                const confidence = receipt.confidence || 3;
                const stars = '‚òÖ'.repeat(confidence) + '‚òÜ'.repeat(5 - confidence);
                const invoiceNum = receipt.invoice_number || '';
                const invoiceDisplay = invoiceNum ? `<span>üî¢ ${invoiceNum}</span>` : '';
                
                return `
                    <div class="receipt-card">
                        <img src="${receipt.thumbnailLink || receipt.webContentLink}" alt="Receipt" class="receipt-thumb" onclick="window.open('${receipt.webContentLink}', '_blank')">
                        <div class="receipt-info">
                            <div class="receipt-store">${receipt.store}</div>
                            <div class="receipt-details">
                                <span>üìÖ ${receipt.date}</span>
                                ${invoiceDisplay}
                                <span class="confidence-stars">${stars}</span>
                            </div>
                        </div>
                        <div>
                            <div class="category-badge ${catInfo.class}">
                                ${catInfo.icon} ${catInfo.name}
                            </div>
                            <div class="receipt-amount">¬•${receipt.amount.toLocaleString()}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('monthlyList').innerHTML = listHTML || '<p style="text-align: center; color: #999; padding: 2rem;">„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
        }
        
        // ExcelÂá∫Âäõ
        async function exportToExcel() {
            const year = document.getElementById('exportYearSelect').value;
            const month = document.getElementById('exportMonthSelect').value;
            
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('loadingText').textContent = 'Excel‰ΩúÊàê‰∏≠...';
            
            try {
                const monthFolderId = await getOrCreateMonthFolder(year, month);
                const receipts = [];
                
                for (const [key, catInfo] of Object.entries(categories)) {
                    const categoryFolderId = await getOrCreateCategoryFolder(monthFolderId, catInfo.name);
                    
                    const response = await gapi.client.drive.files.list({
                        q: `'${categoryFolderId}' in parents and trashed=false`,
                        fields: 'files(id, name, description)',
                        orderBy: 'name'
                    });
                    
                    response.result.files.forEach(file => {
                        try {
                            const desc = JSON.parse(file.description || '{}');
                            receipts.push(desc);
                        } catch (e) {}
                    });
                }
                
                // Excel‰ΩúÊàê
                const wb = XLSX.utils.book_new();
                
                // Ë©≥Á¥∞„Ç∑„Éº„Éà
                const detailData = [['Êó•‰ªò', 'Â∫óËàóÂêç', '„Ç´„ÉÜ„Ç¥„É™', 'ÈáëÈ°ç', 'ÁôªÈå≤Áï™Âè∑', 'Á¢∫‰ø°Â∫¶']];
                
                receipts.forEach(r => {
                    const catInfo = categories[r.category] || categories.other;
                    detailData.push([
                        r.date,
                        r.store,
                        catInfo.name,
                        r.amount,
                        r.invoice_number || '',
                        r.confidence
                    ]);
                });
                
                const detailWs = XLSX.utils.aoa_to_sheet(detailData);
                detailWs['!cols'] = [
                    { wch: 12 }, { wch: 25 }, { wch: 18 },
                    { wch: 12 }, { wch: 18 }, { wch: 10 }
                ];
                XLSX.utils.book_append_sheet(wb, detailWs, 'Ë©≥Á¥∞');
                
                // ÈõÜË®à„Ç∑„Éº„Éà
                const summaryData = [['„Ç´„ÉÜ„Ç¥„É™', '‰ª∂Êï∞', 'ÂêàË®àÈáëÈ°ç']];
                
                Object.entries(categories).forEach(([key, catInfo]) => {
                    const catReceipts = receipts.filter(r => r.category === key);
                    if (catReceipts.length > 0) {
                        const total = catReceipts.reduce((sum, r) => sum + (r.amount || 0), 0);
                        summaryData.push([catInfo.name, catReceipts.length, total]);
                    }
                });
                
                const totalCount = receipts.length;
                const totalAmount = receipts.reduce((sum, r) => sum + (r.amount || 0), 0);
                summaryData.push(['ÂêàË®à', totalCount, totalAmount]);
                
                const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
                summaryWs['!cols'] = [{ wch: 20 }, { wch: 10 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, summaryWs, '„Ç´„ÉÜ„Ç¥„É™Âà•ÈõÜË®à');
                
                XLSX.writeFile(wb, `È†òÂèéÊõ∏ÈõÜË®à_${year}Âπ¥${month}Êúà.xlsx`);
                
            } catch (error) {
                console.error('ExcelÂá∫Âäõ„Ç®„É©„Éº:', error);
                alert('ExcelÂá∫Âäõ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
            
            document.getElementById('loadingSection').style.display = 'none';
        }
        
        // „Ç´„ÉÜ„Ç¥„É™Âà•ÁîªÂÉèZIP
        async function downloadCategorizedImages() {
            const year = document.getElementById('exportYearSelect').value;
            const month = document.getElementById('exportMonthSelect').value;
            
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('loadingText').textContent = 'ÁîªÂÉè„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ‰∏≠...';
            
            try {
                const monthFolderId = await getOrCreateMonthFolder(year, month);
                const zip = new JSZip();
                
                for (const [key, catInfo] of Object.entries(categories)) {
                    const categoryFolderId = await getOrCreateCategoryFolder(monthFolderId, catInfo.name);
                    
                    const response = await gapi.client.drive.files.list({
                        q: `'${categoryFolderId}' in parents and trashed=false`,
                        fields: 'files(id, name, webContentLink)'
                    });
                    
                    const folder = zip.folder(catInfo.name);
                    
                    for (const file of response.result.files) {
                        const fileResponse = await fetch(file.webContentLink);
                        const blob = await fileResponse.blob();
                        folder.file(file.name, blob);
                    }
                }
                
                const content = await zip.generateAsync({ type: 'blob' });
                saveAs(content, `È†òÂèéÊõ∏ÁîªÂÉè_${year}Âπ¥${month}Êúà.zip`);
                
            } catch (error) {
                console.error('ÁîªÂÉè„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Ç®„É©„Éº:', error);
                alert('ÁîªÂÉè„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
            
            document.getElementById('loadingSection').style.display = 'none';
        }
        
        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ
        window.onload = function() {
            gapiLoad();
        };
    </script>
</body>
</html>
